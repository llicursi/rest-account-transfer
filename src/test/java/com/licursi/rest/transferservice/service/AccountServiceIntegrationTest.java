package com.licursi.rest.transferservice.service;

import com.licursi.rest.transferservice.AccountBuilder;
import com.licursi.rest.transferservice.exceptions.BalanceConstraintViolationException;
import com.licursi.rest.transferservice.exceptions.NegativeConstraintViolationException;
import com.licursi.rest.transferservice.model.Account;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.math.BigDecimal;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;


@RunWith(SpringRunner.class)
@SpringBootTest
public class AccountServiceIntegrationTest {

    @Autowired
    private AccountService accountService;

    private Account accountJorahMormont;

    @Before
    public void setup() {

        accountJorahMormont = AccountBuilder.createGeneric("Jorah Mormont").id(7).balance("100000.00").build();
    }

    @Test
    public void whenSave_thenReturnAutoGeneratedId() throws BalanceConstraintViolationException {
        final Account account = AccountBuilder.createGeneric("King Joffrey").noId().build();

        Account accountSaved = accountService.save(account);
        assertThat(accountSaved.getId()).isNotZero();

    }

    @Test(expected = javax.validation.ConstraintViolationException.class)
    public void whenSaveNullName_throwException() throws BalanceConstraintViolationException {
        final Account account = AccountBuilder.createGeneric().noId().noName().build();

        accountService.save(account);
    }

    @Test(expected = org.springframework.transaction.TransactionSystemException.class)
    public void whenSaveWithId_throwException() throws BalanceConstraintViolationException {
        final Account account = AccountBuilder.createGeneric().noName().build();

        accountService.save(account);
    }

    @Test()
    public void whenSaveNullName_throwExceptionWithPropertyPath() {
        final Account account = AccountBuilder.createGeneric().noId().noName().build();

        try {
            accountService.save(account);
        } catch (javax.validation.ConstraintViolationException c){
            assertThat(c.getConstraintViolations().size()).isGreaterThan(0);
            assertThat( c.getConstraintViolations().iterator().next().getPropertyPath().toString()).isEqualTo("name");
        } catch (BalanceConstraintViolationException e) {
            e.printStackTrace();
        }
    }

    @Test()
    public void whenSaveInvalidBalance_throwExceptionWithPropertyPath() throws BalanceConstraintViolationException {
        final Account account = AccountBuilder.createGeneric("Little Finger").noId().balance(new BigDecimal("0.0031987238")).build();

        try {
            accountService.save(account);
        } catch (javax.validation.ConstraintViolationException c) {
            assertThat(c.getConstraintViolations().size()).isGreaterThan(0);
            assertThat(c.getConstraintViolations().iterator().next().getPropertyPath().toString()).isEqualTo("balance");
        }
    }

    @Test(expected = BalanceConstraintViolationException.class)
    public void whenSaveNegativeBalance_throwException() throws BalanceConstraintViolationException {
        final Account sansaStark = AccountBuilder.createGeneric("Sansa Stark").noId().balance(new BigDecimal(-100)).build();

        accountService.save(sansaStark);
        assertThat(true).isTrue();

    }

    @Test(expected = javax.validation.ConstraintViolationException.class)
    public void whenSaveNullBalance_throwException() throws BalanceConstraintViolationException {
        final Account account = AccountBuilder.createGeneric("Tormund").noId().noBalance().build();
        accountService.save(account);
    }


    @Test(expected = NegativeConstraintViolationException.class)
    public void whenDepositNegativeAmount_throwException() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        accountService.deposit(accountJorahMormont, new BigDecimal(-100));

    }

    @Test(expected = NegativeConstraintViolationException.class)
    public void whenDepositeZero_throwException() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        accountService.deposit(accountJorahMormont, new BigDecimal(0));
    }

    @Test
    public void whenDeposit100_thenAccountRiseBy100() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        int finalValue = 100;
        BigDecimal raiseByValue = new BigDecimal("100");

        Account accountSandorClegane = accountService.save(AccountBuilder.createGeneric("Sandor Clegane").balance("0").build());
        accountService.deposit(accountSandorClegane, raiseByValue);
        final Optional<Account> account = accountService.findById(accountSandorClegane.getId());

        assertThat(account.isPresent()).isTrue();
        assertThat(account.get().getBalance().setScale(2)).isEqualTo(new BigDecimal(finalValue).setScale(2));
        assertThat(accountSandorClegane.getBalance().setScale(2)).isEqualTo(new BigDecimal(finalValue).setScale(2));
    }


    @Test
    public void whenDepositFloatingValue_thenAccountRiseByFloatingValue() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        BigDecimal raiseByValue = new BigDecimal("7.33");
        BigDecimal finalValue = new BigDecimal("17.99");

        Account accountAyraStark = accountService.save(AccountBuilder.createGeneric("Arya Stark").balance("10.66").build());
        accountService.deposit(accountAyraStark, raiseByValue);
        final Optional<Account> account = accountService.findById(accountAyraStark.getId());

        assertThat(account.isPresent()).isTrue();
        assertThat(account.get().getBalance()).isEqualTo(finalValue);
        assertThat(accountAyraStark.getBalance()).isEqualTo(finalValue);
    }

    @Test
    public void whenDepositHugeValue_thenAccountRiseByHugeValue() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        BigDecimal raiseByValue = new BigDecimal("999999999989.33");
        BigDecimal finalValue = new BigDecimal("999999999999.99");

        Account accountRobyStark = accountService.save(AccountBuilder.createGeneric("Roby Stark").balance("10.66").build());
        accountService.deposit(accountRobyStark, raiseByValue);
        final Optional<Account> account = accountService.findById(accountRobyStark.getId());

        assertThat(account.isPresent()).isTrue();
        assertThat(account.get().getBalance()).isEqualTo(finalValue);
        assertThat(accountRobyStark.getBalance()).isEqualTo(finalValue);
    }

    @Test(expected = NegativeConstraintViolationException.class)
    public void whenWithdrawNegativeAmount_throwException() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        accountService.withdraw(accountJorahMormont, new BigDecimal(-100));
    }

    @Test(expected = NegativeConstraintViolationException.class)
    public void whenWithdrawZero_throwException() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        accountService.withdraw(accountJorahMormont, new BigDecimal(0));
    }

    @Test
    public void whenWithdraw100_thenBalanceReduceBy100() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        BigDecimal reducedByValue = new BigDecimal("100");
        BigDecimal finalValue = new BigDecimal("0.00");

        Account accountSansaStark = accountService.save(AccountBuilder.createGeneric("Sansa Stark").balance("100").build());
        accountService.withdraw(accountSansaStark, reducedByValue);
        final Optional<Account> account = accountService.findById(accountSansaStark.getId());

        assertThat(account.isPresent()).isTrue();
        assertThat(account.get().getBalance().setScale(2)).isEqualTo(finalValue.setScale(2));
        assertThat(accountSansaStark.getBalance().setScale(2)).isEqualTo(finalValue.setScale(2));
    }


    @Test
    public void whenWithdrawFloatingValue_thenBalanceReduceByFloatingValueKeepingPrecision() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        BigDecimal initialValue = new BigDecimal("10.00");
        BigDecimal reducedByValue = new BigDecimal("9.99");
        BigDecimal finalValue = new BigDecimal("00.01");

        Account accountViserysTargaryen = accountService.save(AccountBuilder.createGeneric("Viserys Targaryen").balance(initialValue).build());
        accountService.withdraw(accountViserysTargaryen, reducedByValue);
        final Optional<Account> account = accountService.findById(accountViserysTargaryen.getId());

        assertThat(account.isPresent()).isTrue();
        assertThat(account.get().getBalance().setScale(2)).isEqualTo(finalValue.setScale(2));
        assertThat(accountViserysTargaryen.getBalance().setScale(2)).isEqualTo(finalValue.setScale(2));

    }

    @Test
    public void whenWithdrawHugeValue_thenBalanceReduceByHugeValueKeepingPrecision() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        BigDecimal finalValue = new BigDecimal("10.66");
        BigDecimal reducedByValue = new BigDecimal("999999999989.33");
        BigDecimal initialValue = new BigDecimal("999999999999.99");
        Account accountCerseiLannister = accountService.save(AccountBuilder.createGeneric("Cersei Lannister").balance(initialValue).build());
        accountService.withdraw(accountCerseiLannister, reducedByValue);
        final Optional<Account> account = accountService.findById(accountCerseiLannister.getId());

        assertThat(account.isPresent()).isTrue();
        assertThat(account.get().getBalance()).isEqualTo(finalValue);
        assertThat(accountCerseiLannister.getBalance()).isEqualTo(finalValue);

    }

    @Test(expected = BalanceConstraintViolationException.class)
    public void whenWithdrawMoreThanAvailable_throwError() throws BalanceConstraintViolationException, NegativeConstraintViolationException {
        Account accountBranStark = accountService.save(AccountBuilder.createGeneric("Bran Stark").balance("2").build());
        accountService.withdraw(accountBranStark, new BigDecimal(3));
    }


}